#!/usr/local/bin/ruby

require 'webrick'
require 'optparse'

OPTIONS = {
  :port            => 3000,
  :ip              => "0.0.0.0",
  :environment     => "development",
  :server_root     => File.expand_path(File.dirname(__FILE__) + "/../public/"),
  :server_type     => WEBrick::SimpleServer,
  :charset         => "UTF-8",
  :mime_types      => WEBrick::HTTPUtils::DefaultMimeTypes
}

ARGV.options do |opts|
  script_name = File.basename($0)
  opts.banner = "Usage: ruby #{script_name} [options]"

  opts.separator ""

  opts.on("-p", "--port=port", Integer,
          "Runs Rails on the specified port.",
          "Default: 3000") { |OPTIONS[:port]| }
  opts.on("-b", "--binding=ip", String,
          "Binds Rails to the specified ip.",
          "Default: 0.0.0.0") { |OPTIONS[:ip]| }
  opts.on("-e", "--environment=name", String,
          "Specifies the environment to run this server under (test/development/production).",
          "Default: development") { |OPTIONS[:environment]| }
  opts.on("-m", "--mime-types=filename", String,
                  "Specifies an Apache style mime.types configuration file to be used for mime types",
                  "Default: none") { |mime_types_file| OPTIONS[:mime_types] = WEBrick::HTTPUtils::load_mime_types(mime_types_file) }

  opts.on("-d", "--daemon",
          "Make Rails run as a Daemon (only works if fork is available -- meaning on *nix)."
          ) { OPTIONS[:server_type] = WEBrick::Daemon }

  opts.on("-c", "--charset=charset", String,
          "Set default charset for output.",
          "Default: UTF-8") { |OPTIONS[:charset]| }

  opts.separator ""

  opts.on("-h", "--help",
          "Show this help message.") { puts opts; exit }

  opts.on("--data-dir=dir", String, 
          "DamageControl data directory", 
          "Default: current dir = #{File.expand_path(Dir.pwd)}") {|dir| DC_DATA_DIR = File.expand_path(dir)}

  opts.parse!
end
DC_DATA_DIR = File.expand_path(File.dirname(__FILE__) + "/..") unless defined? DC_DATA_DIR
puts "DC_DATA_DIR:#{DC_DATA_DIR}"

ENV["RAILS_ENV"] = OPTIONS[:environment]
require File.dirname(__FILE__) + "/../config/environment"
require 'webrick_server'

OPTIONS['working_directory'] = File.expand_path(RAILS_ROOT)

FileUtils.mkdir_p("#{DC_DATA_DIR}/log") unless File.exist?("#{DC_DATA_DIR}/log")
class ::WEBrick::HTTPServer
  access_log_file= "#{DC_DATA_DIR}/log/access.log"
  @@access_log = Logger.new(access_log_file, 10, 1.megabyte)
  @@access_log.datetime_format = "%Y-%m-%d %H:%M:%S"
  @@access_log.level = Logger::INFO

  def access_log(config, req, res)
    @@access_log.info(req.to_s)
  end
end
class ::WEBrick::BasicLog
  webrick_log_file = "#{DC_DATA_DIR}/log/webrick.log"
  @@webrick_log = Logger.new(webrick_log_file, 10, 1.megabyte)
  @@webrick_log.datetime_format = "%Y-%m-%d %H:%M:%S"
  @@webrick_log.level = Logger::INFO

  def log(level, data)
    @@webrick_log.info(data)
  end
end


puts "=> DamageControl WEBrick server started on http://#{OPTIONS[:ip]}:#{OPTIONS[:port]}"
puts "=> Ctrl-C to shutdown server; call with --help for options" if OPTIONS[:server_type] == WEBrick::SimpleServer
DispatchServlet.dispatch(OPTIONS)
